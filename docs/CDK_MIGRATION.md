# CDK Migration Guide: Frontend S3 Configuration

This document describes how to update the frontend to use the CDK-deployed S3 bucket after migrating from AWS Amplify.

## Overview

When migrating from Amplify to CDK, the frontend needs to be updated to use the new infrastructure resources. The main challenge is that `aws-amplify/storage` expects configuration from `aws-exports.js`, which was previously generated by Amplify CLI.

## Solution

We've created a script that generates `aws-exports.js` from CDK stack outputs, maintaining compatibility with the existing frontend code while using CDK infrastructure.

## Migration Steps

### 1. Deploy CDK Infrastructure

First, ensure all CDK stacks are deployed:

```bash
cd cdk
npx cdk deploy --all
```

### 2. Generate Frontend Configuration

After CDK deployment, generate the `aws-exports.js` file:

```bash
# Using AWS CLI (recommended for production)
node scripts/generate-aws-exports.js --env dev

# Using local JSON file (for development/testing)
# First, save CDK outputs to a file
cd cdk
npx cdk deploy --all --outputs-file outputs/cdk-outputs-dev.json
cd ..
node scripts/generate-aws-exports.js --env dev
```

### 3. Verify Configuration

The generated `aws-exports.js` should contain:
- S3 bucket name from CDK deployment
- Cognito User Pool and Identity Pool IDs
- AppSync GraphQL endpoint and API key
- All other required configuration

### 4. Test the Application

1. **Upload Test**: Upload a new audio file and verify it goes to the CDK S3 bucket
2. **List Test**: Ensure existing sounds are listed correctly
3. **Playback Test**: Verify audio files play correctly
4. **Delete Test**: Test file deletion functionality

## Script Options

The `generate-aws-exports.js` script supports:

```bash
# Generate for different environments
node scripts/generate-aws-exports.js --env staging
node scripts/generate-aws-exports.js --env prod

# Output to different location
node scripts/generate-aws-exports.js --output-file src/aws-exports-test.js
```

## Local Development

For local development without AWS access:

1. Copy the example file:
   ```bash
   cp cdk/outputs/cdk-outputs-example.json cdk/outputs/cdk-outputs-dev.json
   ```

2. Edit with your actual CDK outputs

3. Run the generation script:
   ```bash
   node scripts/generate-aws-exports.js --env dev
   ```

## CI/CD Integration

In your CI/CD pipeline:

```yaml
# GitHub Actions example
- name: Generate AWS exports
  run: |
    aws cloudformation describe-stacks --stack-name LittleBit-Core-${{ env.ENVIRONMENT }} --query "Stacks[0].Outputs" > core-outputs.json
    aws cloudformation describe-stacks --stack-name LittleBit-API-${{ env.ENVIRONMENT }} --query "Stacks[0].Outputs" > api-outputs.json
    node scripts/generate-aws-exports.js --env ${{ env.ENVIRONMENT }}
```

## Troubleshooting

### Script Errors

1. **"Failed to obtain CDK outputs"**: Ensure either:
   - AWS CLI is configured with proper credentials
   - CDK outputs JSON file exists at `cdk/outputs/cdk-outputs-{env}.json`

2. **"Missing required stack outputs"**: Verify CDK stacks are fully deployed

### Application Errors

1. **S3 Access Denied**: Check Cognito Identity Pool has proper S3 permissions
2. **File Not Found**: Ensure S3 bucket name in configuration matches deployed bucket
3. **CORS Errors**: Verify S3 bucket CORS configuration allows your domain

## Future Enhancements

After this migration phase, consider:

1. **Direct AWS SDK Usage** (Issue #88): Replace `aws-amplify/storage` with `@aws-sdk/client-s3`
2. **Environment Configuration** (Issue #90): Implement robust configuration management
3. **CI/CD Pipeline** (Issue #89): Automate configuration generation in deployments

## Rollback Plan

If issues arise:

1. Keep backup of original `aws-exports.js`
2. Can temporarily point back to Amplify resources
3. Use dual-bucket support during transition period